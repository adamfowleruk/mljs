
com=window.com||{};com.marklogic=window.com.marklogic||{};com.marklogic.widgets=window.com.marklogic.widgets||{};com.marklogic.widgets.highcharts=function(container){this.container=container;this.aggregateFunction="mean";this.nameSource="title";this.valueSource="value";this.categorySource="category";this.autoCategories=false;this._title="Title";this._subtitle="Subtitle";this._xTitle="Categories";this._yTitle="Values";this._type="line";this._seriesNameToFacetName={};this.ctx=mljs.defaultconnection.createSearchContext();this.categoryOrdering="month";this.categories=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];this.series=new Array();this.errorPublisher=new com.marklogic.events.Publisher();this._updateOptions();this._refresh();};com.marklogic.widgets.highcharts.prototype.setSearchContext=function(c){this.ctx=c;};com.marklogic.widgets.highcharts.getConfigurationDefinition=function(){return{title:{type:"string",default:"My Chart",title:"Chart Title",description:"Main chart title."},subtitle:{type:"string",default:"",title:"Chart Subtitle",description:"Chart Subtitle."},xTitle:{type:"string",default:"",title:"X Axis Title",description:"Category X Axis Title."},yTitle:{type:"string",default:"Values",title:"Y Axis Title",description:"Value Y Axis Title."},type:{type:"enum",default:"line",title:"Chart Type",description:"Which HighCharts chart to display",options:[{value:"line",title:"Line",description:"Line Chart"},{value:"spline",title:"Spline",description:"Spline Chart"},{value:"bar",title:"Bar",description:"Bar Chart"},{value:"area",title:"Area",description:"Area Chart"},{value:"column",title:"Column",description:"Column Chart"},{value:"pie",title:"Pie",description:"Pie Chart"}]},series:{type:"multiple",minimum:1,default:[{nameSourceType:{value:"element"},nameSource:{value:"title"},autoCategories:{value:true},categorySourceType:{value:"element"},categorySource:{value:"category"},valueSourceType:{value:"element"},valueSource:{value:"value"},aggregateFunction:{value:"none"}}],title:"Data Series",description:"Data Series to show in the same chart",childDefinitions:{nameSourceType:{type:"enum",default:"element",title:"Name Source Type",description:"Where to get the Series name from",options:[{value:"element",title:"Element or JSON key",description:"XML Element value or JSON key value"},{value:"fixed",title:"Fixed value",description:"Fixed (Hardcoded) value"},{value:"facet",title:"Facet",description:"Facet value"},{value:"metadata",title:"Metadata",description:"Metadata extract"}]},nameSource:{type:"string",default:"title",title:"Name Source",description:"The element, JSON key, facet or hardcoded value to use to find the series name (dot delimited)."},autoCategories:{type:"boolean",default:true,title:"Auto Categories",description:"Whether to replace the default categories (month names) with values automatically calculated from the Category Source definition."},categorySourceType:{type:"enum",default:"element",title:"Category Source Type",description:"Where to get the Category from",options:[{value:"element",title:"Element or JSON key",description:"XML Element value or JSON key value"},{value:"facet",title:"Facet",description:"Facet value"},{value:"metadata",title:"Metadata",description:"Metadata extract"}]},categorySource:{type:"string",default:"category",title:"Category Source",description:"The element, JSON key or facet to group the results by (dot delimited)."},valueSourceType:{type:"enum",default:"element",title:"Value Source Type",description:"Where to get the Value from",options:[{value:"element",title:"Element or JSON key",description:"XML Element value or JSON key value"},{value:"facet",title:"Facet",description:"Facet value"},{value:"metadata",title:"Metadata",description:"Metadata extract"}]},valueSource:{type:"string",default:"value",title:"Value Source",description:"The element, JSON key or facet value to use for a data value (dot delimited)."},aggregateFunction:{type:"enum",default:"none",title:"Value Aggregation Function",description:"The client side aggregation function to use. E.g. if extracting value from a document's value. Should be set to 'none' for facet sourced values",options:[{value:"none",title:"None",description:"The value itself will be used"},{value:"count",title:"Count",description:"Use the count of the number of documents with this value"},{value:"mean",title:"Mean",description:"Use the mean average of all values"},{value:"sum",title:"Sum",description:"Use the sum of all values"},{value:"min",title:"Min",description:"Use the minimum value present"},{value:"max",title:"Max",description:"Use the maximum value present"}]}}}}};com.marklogic.widgets.highcharts.prototype.setConfiguration=function(config){for(var prop in config){if(prop=="title"||prop=="subtitle"||prop=="xTitle"||prop=="yTitle"||prop=="type"){mljs.defaultconnection.logger.debug("Setting HighCharts options: "+prop+" to "+config[prop]);this["_"+prop]=config[prop];}}
this._updateOptions();if(undefined!=config&&undefined!=config.series&&Array.isArray(config.series)){for(var s=0,max=config.series.length,series;s<max;s++){series=config.series[s];var name="";var category="";var values="";switch(series.nameSourceType){case"element":break;case"fixed":name="#";break;case"facet":name="!";break;case"metadata":name="^";break;default:break;}
name+=series.nameSource;switch(series.categorySourceType){case"element":break;case"facet":category="!";break;case"metadata":category="^";break;default:break;}
category+=series.categorySource;switch(series.valueSourceType){case"element":break;case"facet":values="!";break;case"metadata":values="^";break;default:break;}
values+=series.valueSource;mljs.defaultconnection.logger.debug("Series info: nameSource: "+name+", categorySource: "+category+", valueSource: "+values);this.setSeriesSources(name,category,values);this.aggregateFunction=series.aggregateFunction;this.autoCategories=series.autoCategories;this[config.type]();}}else{this._title="No series defined";this._subtitle="Cannot render empty chart";}};com.marklogic.widgets.highcharts.prototype.addErrorListener=function(fl){this.errorPublisher.subscribe(fl);};com.marklogic.widgets.highcharts.prototype.removeErrorListener=function(fl){this.errorPublisher.unsubscribe(fl);};com.marklogic.widgets.highcharts.prototype._updateOptions=function(){var hc=this;this.options={chart:{type:hc.type,renderTo:hc.container},title:{text:hc._title},subtitle:{text:hc._subtitle},xAxis:{categories:hc.categories,title:{text:hc._xTitle}},yAxis:{title:{text:hc._yTitle}},tooltip:{enabled:true},plotOptions:{line:{dataLabels:{enabled:false}}},series:this.series};this.line();mljs.defaultconnection.logger.debug("highcharts.prototype._updateOptions(): Options now: "+JSON.stringify(this.options));};com.marklogic.widgets.highcharts.prototype._selectCategory=function(facetName,facetValue){this.ctx.contributeFacet(facetName,facetValue);};com.marklogic.widgets.highcharts.prototype.setAggregateFunction=function(fn){this.aggregateFunction=fn;};com.marklogic.widgets.highcharts.prototype._refresh=function(){mljs.defaultconnection.logger.debug("Options on refresh: "+JSON.stringify(this.options));this.chart=new Highcharts.Chart(this.options);};com.marklogic.widgets.highcharts.prototype.setAutoCategories=function(bv){this.autoCategories=bv;};com.marklogic.widgets.highcharts.prototype.setSeriesSources=function(nameSource,categorySource,valueSource){this.nameSource=nameSource;this.categorySource=categorySource;this.valueSource=valueSource;};com.marklogic.widgets.highcharts.prototype.setDataContext=function(dc){this._dataContext=dc;};com.marklogic.widgets.highcharts.prototype.updateData=function(datacontext){var valSource="";if(this.valueSource.startsWith("#")||this.valueSource.startsWith("!")){valSource=this.valueSource.substring(1);}else{valSource=this.valueSource;}
var seriesNames=new Array();var seriesCounts={};var seriesValues={};var allCategories=new Array();var sn=datacontext.getSeriesNames();for(var s=0,maxs=sn.length,seriesName;s<maxs;s++){seriesName=sn[s];mljs.defaultconnection.logger.debug("highcharts.updateData: reading series: "+seriesName);seriesNames.push(seriesName);seriesValues[seriesName]=new Array();seriesCounts[seriesName]=new Array();var data=datacontext.getData(seriesName);for(var r=0,maxr=data.length,row;r<maxr;r++){row=data[r];var category=row.identity;var value=row.fields[valSource];allCategories.push(category);var categoryValueArray=seriesValues[seriesName][category];if(undefined==categoryValueArray){seriesValues[seriesName][category]=new Array();seriesCounts[seriesName][category]=0;}
seriesValues[seriesName][category].push(value);seriesCounts[seriesName][category]+=1;}}
this._displayResults(seriesNames,seriesCounts,seriesValues,allCategories);};com.marklogic.widgets.highcharts.prototype.updateValues=function(values){if("boolean"==typeof(values)){return;}
var seriesNames=new Array();var seriesCounts={};var seriesValues={};var defName="Co-occurrence";seriesNames.push(defName);seriesValues[defName]=new Array();seriesCounts[defName]=new Array();var allCategories=new Array();if(undefined!=values["values-response"]&&undefined!=values["values-response"].tuple){var tuplesOriginal=values["values-response"].tuple;bubbleSort(tuplesOriginal,"frequency");var tuples=tuplesOriginal;for(var i=0,t,category;i<tuples.length;i++){t=tuples[i];category="";for(var v=0;v<t["distinct-value"].length;v++){var val=t["distinct-value"][v];category+=val["_value"];if(v!=t["distinct-value"].length-1){category+=", ";}}
var value=t.frequency;allCategories.push(category);var categoryValueArray=seriesValues[defName][category];if(undefined==categoryValueArray){seriesValues[defName][category]=new Array();seriesCounts[defName][category]=0;}
seriesValues[defName][category].push(value);seriesCounts[defName][category]+=1;}}else{}
this._displayResults(seriesNames,seriesCounts,seriesValues,allCategories);};com.marklogic.widgets.highcharts.prototype.updateSubjectFacts=function(facts){if(false==facts||true==facts){return;}
mljs.defaultconnection.logger.debug("in highcharts.updateSubjectFacts()");mljs.defaultconnection.logger.debug(" - looping over facts");for(var r=0;r<facts.facts.bindings.length;r++){var result=facts.facts.bindings[r];var name="";var resdoc=jsonOrXml(result);if(this.nameSource.startsWith("#")){name=this.nameSource.substring(1);}else{name=extractValue(resdoc,this.nameSource);}
var value=extractValue(resdoc,this.valueSource);var category=extractValue(resdoc,this.categorySource);if(!allCategories.contains(category)){allCategories.push(category);}
if(!seriesNames.contains(name)){seriesNames.push(name);seriesValues[name]=new Array();seriesCounts[name]=new Array();}
var categoryValueArray=seriesValues[name][category];if(undefined==categoryValueArray){seriesValues[name][category]=new Array();seriesCounts[name][category]=0;}
seriesValues[name][category].push(value);seriesCounts[name][category]+=1;}
mljs.defaultconnection.logger.debug(" - finished looping over facts");this._displayResults(seriesNames,seriesCounts,seriesValues,allCategories);};com.marklogic.widgets.highcharts.prototype.updateResults=function(results){mljs.defaultconnection.logger.debug("in highcharts.updateResults()");if(false==results||true==results){return;}
mljs.defaultconnection.logger.debug(" - results: "+JSON.stringify(results));var seriesNames=new Array();var seriesValues=new Array();var seriesCounts=new Array();var allCategories=new Array();mljs.defaultconnection.logger.debug("Category source: "+this.categorySource);if(this.categorySource.startsWith("!")){mljs.defaultconnection.logger.debug("Loading series data from facet");this.aggregateFunction="none";var name=this.nameSource.substring(1);var facetName=this.categorySource.substring(1);mljs.defaultconnection.logger.debug(" - Facet title: "+name+", facet name: "+facetName);seriesNames.push(facetName);var facetValues=results.facets[facetName].facetValues;seriesValues[facetName]=new Array();seriesCounts[facetName]=new Array();mljs.defaultconnection.logger.debug(" - Number of facet values: "+facetValues.length);for(var i=0;i<facetValues.length;i++){seriesValues[facetName][facetValues[i].name]=new Array();seriesValues[facetName][facetValues[i].name].push(facetValues[i].count);if(!allCategories.contains(facetValues[i].name)){allCategories.push(facetValues[i].name);}
seriesCounts[facetName][facetValues[i].name]=1;}}else if(this.categorySource.startsWith("^")){var extractMeta=function(r,field){var f=field.substring(1);mljs.defaultconnection.logger.debug("extractMeta: searching for field named "+f);for(var i=0,maxi=r.metadata.length,meta;i<maxi;i++){meta=r.metadata[i];if(undefined!=meta[f]){mljs.defaultconnection.logger.debug("Found field "+f+" with value "+meta[f]);return meta[f];}}
return null;};mljs.defaultconnection.logger.debug(" - looping over results[metadata]");for(var r=0;r<results.results.length;r++){var result=results.results[r];var name="";if(this.nameSource.startsWith("#")){name=this.nameSource.substring(1);}else{name=extractMeta(result,this.nameSource);}
var value=extractMeta(result,this.valueSource);if(this.categorySource.startsWith("!")){this._seriesNameToFacetName[name]=this.categorySource.substring(1);}else{this._seriesNameToFacetName[name]=this.categorySource;}
var category=extractMeta(result,this.categorySource);if(!allCategories.contains(category)){allCategories.push(category);}
if(!seriesNames.contains(name)){seriesNames.push(name);seriesValues[name]=new Array();seriesCounts[name]=new Array();}
var categoryValueArray=seriesValues[name][category];if(undefined==categoryValueArray){seriesValues[name][category]=new Array();seriesCounts[name][category]=0;}
seriesValues[name][category].push(value);seriesCounts[name][category]+=1;}
mljs.defaultconnection.logger.debug(" - finished looping over results[metadata]");}else{mljs.defaultconnection.logger.debug(" - looping over results");for(var r=0;r<results.results.length;r++){var result=results.results[r].content;var name="";var resdoc=jsonOrXml(result);if(this.nameSource.startsWith("#")){name=this.nameSource.substring(1);}else{name=extractValue(resdoc,this.nameSource);}
var value=extractValue(resdoc,this.valueSource);if(this.categorySource.startsWith("!")){this._seriesNameToFacetName[name]=this.categorySource.substring(1);}else{this._seriesNameToFacetName[name]=this.categorySource;}
var category=extractValue(resdoc,this.categorySource);if(!allCategories.contains(category)){allCategories.push(category);}
if(!seriesNames.contains(name)){seriesNames.push(name);seriesValues[name]=new Array();seriesCounts[name]=new Array();}
var categoryValueArray=seriesValues[name][category];if(undefined==categoryValueArray){seriesValues[name][category]=new Array();seriesCounts[name][category]=0;}
seriesValues[name][category].push(value);seriesCounts[name][category]+=1;}
mljs.defaultconnection.logger.debug(" - finished looping over results");}
this._displayResults(seriesNames,seriesCounts,seriesValues,allCategories);};com.marklogic.widgets.highcharts.prototype._displayResults=function(seriesNames,seriesCounts,seriesValues,allCategories){if(this.autoCategories){mljs.defaultconnection.logger.debug("updateResults(): Auto categories enabled");this.categories=allCategories;}
mljs.defaultconnection.logger.debug("Series names: "+JSON.stringify(seriesNames));mljs.defaultconnection.logger.debug("Series Values: "+JSON.stringify(seriesValues));var sum=function(arr){var sum=0;for(var i=0;i<arr.length;i++){sum+=arr[i];}
return sum;};var mean=function(arr){if(undefined==arr){return 0;}
var sum=0;for(var i=0;i<arr.length;i++){sum+=arr[i];}
return sum/arr.length;};var min=function(arr){var min=arr[0];for(var i=1;i<arr.length;i++){if(arr[i]<min){min=arr[i];}}
return min;};var max=function(arr){var max=arr[0];for(var i=1;i<arr.length;i++){if(arr[i]>max){max=arr[i];}}
return max;};var count=function(arr){return arr.length;};var none=function(arr){return arr[0];};var func=sum;if("mean"==this.aggregateFunction){func=mean;}else if("min"==this.aggregateFunction){func=min;}else if("max"==this.aggregateFunction){func=max;}else if("count"==this.aggregateFunction){func=count;}else if("none"==this.aggregateFunction){func=none;}
var series=new Array();for(var n=0;n<seriesNames.length;n++){var name=seriesNames[n];if("pie"==this.options.chart.type){var data=new Array();for(var p=0;p<this.categories.length;p++){var json={name:this.categories[p],y:seriesValues[name][this.categories[p]][0]};data.push(json);}
series[n]={type:"pie",name:name,data:data};}else{var orderedData=new Array();for(var p=0;p<this.categories.length;p++){orderedData[p]=func(seriesValues[name][this.categories[p]]);}
series[n]={name:name,data:orderedData};}}
this.options.series=series;this.options.xAxis.categories=this.categories;this._refresh();};com.marklogic.widgets.highcharts.prototype.noclick=function(){this.options.plotOptions[this.options.chart.type].point.events.click=function(){};return this;};com.marklogic.widgets.highcharts.prototype._addPointClickHandler=function(charttype){var self=this;this.options.plotOptions[charttype].point={events:{click:function(){var data=this.series.data[this.x].name;console.log("Point clicked: x:"+this.x+", series name:'"+this.series.name+"', y:"+this.y," data name: "+data);if(undefined==data){data=this.category;self._selectCategory(self._seriesNameToFacetName[this.series.name],data);}else{self._selectCategory(this.series.name,data);}}}};};com.marklogic.widgets.highcharts.prototype.line=function(extra_params_opt){this.options.chart.type='line';this._type="line";this.options.plotOptions.line={dataLabels:{enabled:false}};for(var n in extra_params_opt){this.options.plotOptions.line[n]=extra_params_opt[n];}
this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.spline=function(extra_params_opt){this.options.chart.type='spline';this._type="spline";this.options.plotOptions.line=undefined;this.options.plotOptions.spline={dataLabels:{enabled:false}};for(var n in extra_params_opt){this.options.plotOptions.spline[n]=extra_params_opt[n];}
this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.column=function(extra_params_opt){this.options.chart.type="column";this._type="column";this.options.plotOptions.line=undefined;this.options.plotOptions.column={pointPadding:0.2,borderWidth:0,dataLabels:{enabled:true,style:{fontWeight:'bold'}}};for(var n in extra_params_opt){this.options.plotOptions.column[n]=extra_params_opt[n];}
this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.pie=function(extra_params_opt){this.options.chart.type="pie";this.options.plotOptions.line=undefined;this.options.plotOptions.pie={};for(var n in extra_params_opt){this.options.plotOptions.pie[n]=extra_params_opt[n];}
this._type="pie";this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.bar=function(extra_params_opt){this.options.chart.type="bar";this.options.plotOptions.line=undefined;this.options.plotOptions.bar={};for(var n in extra_params_opt){this.options.plotOptions.bar[n]=extra_params_opt[n];}
this._type="bar";this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.area=function(extra_params_opt){this.options.chart.type="area";this._type="area";this.options.plotOptions.line=undefined;this.options.plotOptions.area={};for(var n in extra_params_opt){this.options.plotOptions.area[n]=extra_params_opt[n];}
this._addPointClickHandler(this.options.chart.type);return this;};com.marklogic.widgets.highcharts.prototype.crosshairs=function(){this.options.tooltip.crosshairs=[true,true];return this;};com.marklogic.widgets.highcharts.prototype.nolegend=function(){this.legend(false);};com.marklogic.widgets.highcharts.prototype.legend=function(enabled){if(undefined==enabled){enabled=true;}
if(enabled){this.options.legend.enabled=true;}else{this.options.legend.enabled=false;}};com.marklogic.widgets.highcharts.prototype.inverted=function(){this.options.chart.inverted=true;return this;};com.marklogic.widgets.highcharts.prototype.stacked=function(){this.options.plotOptions.series={stacking:'normal'};return this;};com.marklogic.widgets.highcharts.prototype.stackLabels=function(stackLabels){this.options.yAxis.stackLabels=stackLabels;return this;};com.marklogic.widgets.highcharts.prototype.title=function(title){this.options.title.text=title;this._title=title;return this;};com.marklogic.widgets.highcharts.prototype.subtitle=function(subtitle){this.options.subtitle.text=subtitle;this._subtitle=subtitle;return this;};com.marklogic.widgets.highcharts.prototype.yTitle=function(yTitle){this.options.yAxis.title.text=yTitle;this._yTitle=yTitle;return this;};com.marklogic.widgets.highcharts.prototype.xTitle=function(xTitle){this.options.xAxis.title.text=xTitle;this._xTitle=xTitle;return this;};